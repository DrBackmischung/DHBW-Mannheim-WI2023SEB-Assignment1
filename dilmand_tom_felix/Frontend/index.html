<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Smart Lamp UI</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<h1>ðŸ’¡ Smart Lamp Steuerung</h1>

<!-- Digitale Darstellung der physischen Lampe -->
<div class="lamp" id="lamp"></div>

<!-- Textuelle Statusanzeige -->
<div class="status-box" id="statusBox">Lampe ist AUS</div>

<section class="controls">
  <button id="toggleBtn">Lampe Einschalten</button>

  <label for="brightness">ðŸ”† Helligkeit:</label>
  <input type="range" id="brightness" min="0" max="100" value="100">
  <span id="brightnessValue">100%</span>

  <label for="color">ðŸŽ¨ Farbe:</label>
  <input type="color" id="color" value="#ffffff">

  <label for="morseInput">ðŸ“¡ Morsecode-Nachricht:</label>
  <input type="text" id="morseInput" placeholder="Text eingeben...">
  <button id="morseBtn">Morsecode abspielen</button>
</section>

<script>
  const toggleBtn = document.getElementById("toggleBtn");
  const brightnessInput = document.getElementById("brightness");
  const brightnessValue = document.getElementById("brightnessValue");
  const colorInput = document.getElementById("color");
  const statusBox = document.getElementById("statusBox");
  const lamp = document.getElementById("lamp");

  let isOn = false;
  let brightness = 100;
  let color = "#ffffff";

  async function updateStatus(message, success = true) {
    statusBox.textContent = message;
    statusBox.style.backgroundColor = success ? "#e3f2fd" : "#ffebee";
  }

  async function sendRequest(endpoint, body = null) {
    try {
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: body ? JSON.stringify(body) : null
      });
      const data = await res.json();
      updateStatus(data.message || "OK", res.ok);
    } catch (err) {
      updateStatus("Netzwerkfehler", false);
    }
  }

  toggleBtn.addEventListener("click", async () => {
    isOn = !isOn;
    await sendRequest(isOn ? "/api/lamp/on" : "/api/lamp/off");
    toggleBtn.textContent = isOn ? "Lampe Ausschalten" : "Lampe Einschalten";
  });

  brightnessInput.addEventListener("input", async () => {
    brightness = Number(brightnessInput.value);
    brightnessValue.textContent = `${brightness}%`;
    await sendRequest("/api/lamp/brightness", { value: brightness });
  });

  colorInput.addEventListener("input", async () => {
    color = colorInput.value;
    await sendRequest("/api/lamp/color", { value: color });
  });

  // Morse: optional â€“ keine API definiert, hier nur Dummy
  document.getElementById("morseBtn").addEventListener("click", () => {
    alert("Morsecode-Funktion lokal â€“ keine API vorhanden.");
  });

  // Holt den echten Lampenzustand vom Consumer (via Docker-Service-Namen)
  async function pollLampStatus() {
    try {
      const res = await fetch("/lamp/status");
      const data = await res.json();
      updateLampView(data);
    } catch (err) {
      updateStatus("Status konnte nicht geladen werden", false);
    }
  }

  // Zeigt die Lampe basierend auf realem Zustand
  function updateLampView(state) {
    isOn = state.poweredOn;
    brightness = state.brightness;
    color = state.color;

    lamp.style.backgroundColor = isOn ? color : "#222";
    lamp.style.opacity = isOn ? (brightness / 100).toString() : "0.2";

    statusBox.textContent = `Lampe ist ${isOn ? "AN" : "AUS"} | Farbe: ${color} | Helligkeit: ${brightness}%`;
    toggleBtn.textContent = isOn ? "Lampe Ausschalten" : "Lampe Einschalten";
    brightnessInput.value = brightness;
    brightnessValue.textContent = `${brightness}%`;
    colorInput.value = color;
  }

  // Status regelmÃ¤ÃŸig abfragen
  setInterval(pollLampStatus, 2000);
  pollLampStatus(); // einmal beim Start
</script>
</body>
</html>
